<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>BCFerryCoder Blogs</title>
    <meta name="description" content="">
    <meta name="author" content="Name Lastname">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script
src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link
href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css"
rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1"
rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72"
href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114"
href="images/apple-touch-icon-114x114.png">
  -->
<link rel="stylesheet" href="styles/default.css">
<link rel="stylesheet"
      href="/assets/highlight.js-master/src/styles/zenburn.css">

<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
  <style>

     a:link.plainlink {color:black;}
     a:visited.plainlink {color:black;}
     a:hover.plainlink {color:#007040;}
     a:active {color:#00ffff;}

     .imagebutton {
       pad-top: 100px;
       margin-left: 18px;
     }

    .differentiator {
      font-size: 15px;
    }

  </style>

  </head>

  <body>

    <div style="margin-top:30px;" class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">BCFerryCoder</a>
          <ul class="nav">
      <li><a href="/topics/stackato/">Stackato/PaaS</a></li>
      <li><a href="/topics/java/">Java</a></li>
      <li><a href="/topics/tools/">Tools</a></li>
      <li><a href="/topics/enterprise/">Enterprise Software</a></li>
      <li><a href="/topics/untools/">Untools</a></li>
      <li><a href="/topics/blog/">Blog</a></li>
      <li><a href="#"></a></li>
      <li><a href="#"></a></li>
<!--<li style="line-height:5px;"><img style="position:absolute;top:20px;padding-top:5px;margin-bottom:0px;padding-bottom:0px;" src="/assets/images/dingy.png" width="115"></li>-->
<li style="line-height:5px;"><img style="position:absolute;top:4px;padding-top:5px;margin-bottom:0px;padding-bottom:0px;" src="/assets/images/bcferrycoder_nobg.png" width="185"></li>
          </ul>
        </div>
      </div>
    </div>

<div class="container">
  <div class="content">
    <div style="width:104%;margin-left:-19px;margin-top:-21px;" class="box" style="background-color:black;color:white;">
      <img width="110%" src="/assets/images/thinocean.png">
    </div>


    <div class="container">

      <div class="content">
        <div class="page-header">

  <h1>Upgrading TomEE in vcap <small>On the Road with PaaS</small></h1>
</div>

<div class="row">
  <div class="span8">

    <h2 id='upgrade_the_stackatobundled_tomee_instance'>Upgrade the Stackato-bundled TomEE instance</h2>

<p>Stackato v2.0 bundles TomEE v1.0. This version of TomEE results in library incompabilies prompting us to upgrade to TomEE v1.5.0 which fixes these issues.</p>

<p>This document describes the steps taken to upgrade TomEE to 1.5.</p>

<h3 id='short_version'>Short version</h3>

<ol>
<li>Download and verify TomEE 1.5 Plus from <a href='http://openejb.apache.org/downloads.html'>http://openejb.apache.org/downloads.html</a></li>

<li>Remove unneeded files</li>

<li>Add TomcatStartupListener-1.0.jar from vcap-java</li>

<li>update tomcat context descriptor (conf/context.xml)</li>

<li>zip to tomcat.zip</li>

<li>test with AppStore</li>

<li>push to vcap-staging repo</li>
</ol>

<h3 id='detailed_steps'>Detailed Steps</h3>

<ul>
<li>
<p>Download TomEE 1.5 Plus pack from <a href='http://openejb.apache.org/downloads.html'>http://openejb.apache.org/downloads.html</a></p>

<p>Note: you&#8217;ll see a comment <strong>NOT Java EE6 Certified</strong> on this page, which you can ignore: it applies to additional libraries bundled with TomEE Plus. The core is TomEE certified, and the additional libraries are needed for Stackato.</p>
</li>

<li>
<p>Verify md5 sig of downloaded bits</p>

<pre><code>   $ md5 apache-tomee-1.5.0-plus.tar.gz</code></pre>

<p>And compare the output to the authoritative signature at <a href='https://repository.apache.org/content/groups/public/org/apache/openejb/apache-tomee/1.5.0/'>https://repository.apache.org/content/groups/public/org/apache/openejb/apache-tomee/1.5.0/</a></p>
</li>

<li>
<p>Install a fresh Stackato VM, launch it, ssh to api and navigate to the directory where the tomcat.zip is stored:</p>

<pre><code>   $ stackato ssh api
   $ cd stackato/vcap/staging/lib/vcap/staging/plugin/tomcat_common/resources</code></pre>

<p>This directory contains tomcat.zip, which is the archived version of tomcat that&#8217;s deployed to each application instance that requires it. You will be replacing this tomcat.zip with the bits for TomEE 1.5.</p>
</li>

<li>
<p>Move the existing tomcat.zip out of here and unpack the downloaded TomEE tarball:</p>

<pre><code>   $ mv tomcat.zip /tmp/
   $ tar xzf  apache-tomee-1.5.0-plus.tar.gz</code></pre>
</li>

<li>
<p>Rename the directory to &#8220;tomcat&#8221; so it zips with correct structure:</p>

<pre><code>   $ mv  apache-tomee-plus-1.5.0 tomcat</code></pre>
</li>

<li>
<p>Clean it up: tomcat includes files we don&#8217;t need, and a few that must be removed.</p>

<pre><code>   $ cd tomcat

   # these files are not required, can be safely removed
   $ rm LICENSE NOTICE RUNNING.txt RELEASE-NOTES
   $ rm bin/*.bat bin/*.exe bin/*original* bin/*.txt

   # the default apps in webapps must be removed (for example the
   #  &quot;manager&quot; and host-manager should not be available in each app instance)
   $ rm -rf webapps/*

   # ensure everything in bin is executable
   $ chmod a+x bin/*</code></pre>
</li>
</ul>

<p>VCAP needs to manage the tomcat lifecycle, which it accomplishes by registering a TomcatStartupListener in the tomcat context. This listener is part of vcap-java, in <strong>vcap-java/plugins/tomcat_startup_listener</strong></p>

<ul>
<li>
<p>Rebuild the tomcat_startup_listener package:</p>

<pre><code>   $ cd vcap-java/plugins/tomcat_startup_listener
   $ mvn clean package</code></pre>

<p>And copy the resulting target/TomcatStartupListener-1.0.jar to the lib directory in the new tomcat distribution:</p>

<pre><code>   $ scp target/TomcatStartupListener-1.0.jar
   stackato@stackato-aaaa.local:stackato/vcap/staging/lib/vcap/staging/plugin/tomcat_common/resources/tomcat/lib/</code></pre>
</li>

<li>
<p>The tomcat conf/context.xml file needs an additional &#8220;Listener&#8221; directive to enable the startup listener. Edit conf/context.xml to add the directive. Here is a minimal context.xml with comments stripped:</p>

<pre><code>   &lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;
   &lt;Context&gt;
     &lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;
     &lt;Listener className=&quot;com.vmware.appcloud.tomcat.AppCloudLifecycleListener&quot; /&gt;
   &lt;/Context&gt;</code></pre>
</li>

<li>
<p>Package up the new tomcat.zip, and remove the unzipped dir:</p>

<pre><code>   zip -r tomcat.zip tomcat
   rm -rf tomcat</code></pre>
</li>

<li>
<p>Now test. From the web console visit the App Store and deploy: pet-catalog, Kitchensink, and Movie Fun. These should be working and if so the new tomcat.zip is ready to be pushed to the vcap-staging repo.</p>
</li>

<li>
<p>Clone vcap-staging, replace tomcat.zip, and commit:</p>

<pre><code>   git clone gitolite@gitolite.activestate.com:vcap-staging.git
   cp tomcat.zip vcap-staging/lib/vcap/staging/plugin/tomcat_common/resources/ 
   git add vcap-staging/lib/vcap/staging/plugin/tomcat_common/resources/tomcat.zip
   git commit...  etc.</code></pre>
</li>

<li>
<p>Watch tomorrow&#8217;s jenkins logs for test failures. Look for &#8220;hello-spring-mysql&#8221; and &#8220;kitchensink&#8221; failures. There should be none, and if so, all is well.</p>
</li>
</ul>

<p>Questions: see <a href='mailto:johnw@activestate.com'>John Wetherill</a></p>

    <hr>
    <hr>
    
  </div>

      </div>


      <footer>
        <p>&copy; John Wetherill 2012 </p>
<!--          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          and <a href="https://github.com/isagalaev/highlight.js" target="_blank">Highlight.js</a>
        </p>-->
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>


